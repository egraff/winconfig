clone_depth: 10

environment:
  global:
    MSYS2_DIR: C:\msys64
    MSYS2_ASH: C:\msys64\usr\bin\ash.exe
    MSYS2_BASH: C:\msys64\usr\bin\bash.exe

cache:
  - '%MSYS2_DIR%\var\cache\pacman'

install:
  # Fix MSYS2 signature problem - see https://www.msys2.org/news/#2020-06-29-new-packagers
  - '%MSYS2_BASH% --login -c "curl -O http://repo.msys2.org/msys/x86_64/msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz && curl -O http://repo.msys2.org/msys/x86_64/msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz.sig"'
  - '%MSYS2_BASH% --login -c "pacman-key --verify msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz.sig && pacman -U --noconfirm msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz"'
  - '%MSYS2_BASH% --login -c "pacman -Syuu --noconfirm"'

  # Avoid crash in bash: "shared_info::initialize: size of shared memory region changed from 49080 to 40888"
  # See https://github.com/msys2/MSYS2-packages/issues/258#issuecomment-665469576
  - ps: Get-Process | Where-Object { $_.Path -like "${env:MSYS2_DIR}*" } | Stop-Process

  - '%MSYS2_BASH% --login -c "pacman -Syu --noconfirm"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed base-devel msys2-devel gcc"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed python3 python3-pip"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed libffi libffi-devel"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed openssl openssl-devel libcrypt libcrypt-devel"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed libyaml-devel"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed tar git openssh"'
  - '%MSYS2_BASH% --login -c "pacman -S --noconfirm --needed p7zip"'
  - '%MSYS2_ASH% -c "/usr/bin/rebaseall -v"'
  - '%MSYS2_BASH% --login -c "python3 -mpip install ansible"'
  - '%MSYS2_BASH% --login -c "python3 -mpip install \"pywinrm>=0.3.0\""'
  - '%MSYS2_ASH% -c "/usr/bin/rebaseall -v"'
  - '%MSYS2_BASH% --login -c "curl -L -o 7zsd_extra_170_3900.7z https://github.com/chrislake/7zsfxmm/releases/download/1.7.0.3900/7zsd_extra_170_3900.7z"'
  - '%MSYS2_BASH% --login -c "TARGET_DIR=`cd $APPVEYOR_BUILD_FOLDER && pwd` && mkdir $TARGET_DIR/7zsd_extra && 7z e 7zsd_extra_170_3900.7z -o$TARGET_DIR/7zsd_extra"'

build_script:
  - '%MSYS2_BASH% --login -c "cd $APPVEYOR_BUILD_FOLDER && ./release.sh"'

artifacts:
  - path: winconfig-install.exe
    name: installer
    type: file

# https://www.appveyor.com/docs/how-to/rdp-to-build-worker/
on_failure:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
